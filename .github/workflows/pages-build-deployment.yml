name: pages-build-deployment

on:
  schedule:
    - cron: '01 00 1 1 *'
  push:
    branches: ["main"]
  workflow_dispatch:

env:
  JEKYLL_ENV: "production"
  JEKYLL_DESTINATION: "./_site"
  RUBY_VERSION: 2.7.5

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Code checkout
        uses: actions/checkout@v3

      - name: Node.js setup
        uses: actions/setup-node@v3
        with:
          node-version: 'lts/*'
          cache: 'yarn'

      - name: Yarn install
        run: yarn install --frozen-lockfile
        # if: ${{ steps.yarn-cache.outputs.cache-hit != 'true' }}

      - name: Ruby cache
        uses: actions/cache@v3
        with:
          path: vendor/bundle
          key: ${{ runner.os }}-gems-${{ hashFiles('**/Gemfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-gems-

      - name: Ruby setup
        uses: ruby/setup-ruby@v1
        if: ${{ github.actor != 'nektos/act' }}
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true

      - name: Ruby setup
        uses: ruby/setup-ruby@v1
        if: ${{ github.actor == 'nektos/act' }}
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: false

      - if: ${{ github.actor == 'nektos/act' }}
        run: bundle install

      - name: jekyll build development
        run: bundle exec rake
        env: 
          JEKYLL_ENV: development

      - run: rm -rf ${{ env.JEKYLL_DESTINATION }} .jekyll-cache

      - name: jekyll build production
        run: bundle exec rake
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          JEKYLL_GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OCTOKIT_ACCESS_TOKEN: ${{ secrets.GITHUB_TOKEN }}

#  release:
#    needs: build
#    runs-on: ubuntu-latest
#
#    steps:
      - name: Version get latest tag
        id: latesttag
        run: |
          LASTEST_TAG=$(git describe --tags --abbrev=0)
          echo "LASTEST_TAG=$LASTEST_TAG" >> $GITHUB_ENV
          if [ -z "$LASTEST_TAG" ]
          then
            echo "No tag found. Using default version 0.0.0"
            echo "LASTEST_TAG=0.0.0" >> $GITHUB_ENV
          fi

      - name: Version increment
        run: |
          IFS='.' read -ra ADDR <<< "$LASTEST_TAG"
          ADDR[2]=$((ADDR[2] + 1))
          VERSION="${ADDR[0]}.${ADDR[1]}.${ADDR[2]}"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
        shell: bash

      - name: Release create
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ env.VERSION }}
          release_name: Release ${{ env.VERSION }} at $(date -u +"%Y-%m-%dT%H:%M:%S.%3NZ")
          draft: false
          prerelease: true

      - name: Release asset upload
        id: upload-release-asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ env.JEKYLL_DESTINATION }}
          asset_name: site.zip
          asset_content_type: application/zip

#  deploy:
#    needs: release
#    runs-on: ubuntu-latest
#
#    steps:
      - name: GitHub Pages setup
        uses: actions/configure-pages@v2
        id: pages
        if: ${{ github.actor != 'nektos/act' }}
        continue-on-error: true

      - name: GitHub Pages upload artifact
        uses: actions/upload-pages-artifact@v1.0.4
        if: ${{ success() && github.actor != 'nektos/act' }}
        continue-on-error: true
        with:
          path: ${{ env.JEKYLL_DESTINATION }}

      - name: Cloudflare Pages publish
        uses: cloudflare/pages-action@v1
        if: ${{ success() && github.actor != 'nektos/act' }}
        with:
          apiToken: ${{ secrets.CLOUDFLARE_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: zuralski-net
          directory: ${{ env.JEKYLL_DESTINATION }}
